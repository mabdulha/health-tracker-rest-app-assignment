<?xml version="1.0" encoding="UTF-8"?><!DOCTYPE html PUBLIC "-//W3C//DTD XHTML 1.0 Strict//EN" "http://www.w3.org/TR/xhtml1/DTD/xhtml1-strict.dtd"><html xmlns="http://www.w3.org/1999/xhtml" lang="en"><head><meta http-equiv="Content-Type" content="text/html;charset=UTF-8"/><link rel="stylesheet" href="../jacoco-resources/report.css" type="text/css"/><link rel="shortcut icon" href="../jacoco-resources/report.gif" type="image/gif"/><title>HealthTrackerAPI.kt</title><link rel="stylesheet" href="../jacoco-resources/prettify.css" type="text/css"/><script type="text/javascript" src="../jacoco-resources/prettify.js"></script></head><body onload="window['PR_TAB_WIDTH']=4;prettyPrint()"><div class="breadcrumb" id="breadcrumb"><span class="info"><a href="../jacoco-sessions.html" class="el_session">Sessions</a></span><a href="../index.html" class="el_report">org.wit healthtrackerrest</a> &gt; <a href="index.source.html" class="el_package">org.wit.controllers</a> &gt; <span class="el_source">HealthTrackerAPI.kt</span></div><h1>HealthTrackerAPI.kt</h1><pre class="source lang-java linenums">package org.wit.controllers

import com.fasterxml.jackson.module.kotlin.jacksonObjectMapper
import com.fasterxml.jackson.module.kotlin.readValue
import com.harium.dotenv.Env
import io.javalin.http.Context
import io.jsonwebtoken.Jwts
import io.jsonwebtoken.security.Keys
import kotlin.math.round
import org.wit.domain.*
import org.wit.repository.*
import org.wit.utilities.decryptPassword
import org.wit.utilities.jsonToObject
import java.util.*

<span class="fc" id="L16">object HealthTrackerAPI {</span>

<span class="fc" id="L18">    private val userDao = UserDAO()</span>
<span class="fc" id="L19">    private val exerciseDao = ExerciseDAO()</span>
<span class="fc" id="L20">    private val mealDao = MealDAO()</span>
<span class="fc" id="L21">    private val ingredientDao = IngredientDAO()</span>
<span class="fc" id="L22">    private val userBmiDAO = UserBmiDAO()</span>

    //-------------------------------------------------------------
    // UserDAO specifics
    //-------------------------------------------------------------

    fun getAllUsers(ctx: Context) {
<span class="fc" id="L29">        val users = userDao.getAll()</span>
<span class="pc bpc" id="L30" title="1 of 2 branches missed.">        if (users.size != 0) {</span>
<span class="fc" id="L31">            ctx.json(users)</span>
<span class="fc" id="L32">            ctx.status(200)</span>
        } else {
<span class="nc" id="L34">            ctx.status(404)</span>
<span class="nc" id="L35">            ctx.html(&quot;Error 404 - No Users Found!!&quot;)</span>
        }
<span class="fc" id="L37">    }</span>

    fun countAllUsers (ctx: Context) {
<span class="nc" id="L40">        val users = userDao.getAll().size</span>
<span class="nc bnc" id="L41" title="All 2 branches missed.">        if (users != 0) {</span>
<span class="nc" id="L42">            ctx.status(200).json(users)</span>
        } else {
<span class="nc" id="L44">            ctx.status(404).json(&quot;Error 404 - No Users Found!!&quot;)</span>
        }
<span class="nc" id="L46">    }</span>

    fun getUserByUserId(ctx: Context) {
<span class="fc" id="L49">        val foundId = ctx.pathParam(&quot;user-id&quot;).toInt()</span>
<span class="fc" id="L50">        val user = userDao.findById(foundId)</span>
<span class="fc bfc" id="L51" title="All 2 branches covered.">        if (user != null) {</span>
<span class="fc" id="L52">            ctx.status(200).json(user)</span>
        } else {
<span class="fc" id="L54">            ctx.status(404).json(&quot;No user found with id: $foundId&quot;)</span>
        }
<span class="fc" id="L56">    }</span>

    fun addUser(ctx: Context) {
<span class="fc" id="L59">        val user : UserDTO = jsonToObject(ctx.body())</span>
<span class="fc bfc" id="L60" title="All 2 branches covered.">        if (userDao.findByEmail(user.email) == null) {</span>
<span class="fc" id="L61">            val userId = userDao.save(user)</span>
<span class="pc bpc" id="L62" title="1 of 2 branches missed.">            if (userId != null) {</span>
<span class="fc" id="L63">                user.id = userId</span>
<span class="fc" id="L64">                ctx.status(201).json(user)</span>
            }
        } else {
<span class="fc" id="L67">            ctx.status(409).json(&quot;The email: ${user.email}, already exists&quot;)</span>
        }

<span class="fc" id="L70">    }</span>

    fun getUserByEmail(ctx: Context) {
<span class="fc" id="L73">        val foundEmail = ctx.pathParam(&quot;email&quot;)</span>
<span class="fc" id="L74">        val user = userDao.findByEmail(foundEmail)</span>
<span class="fc bfc" id="L75" title="All 2 branches covered.">        if (user != null) {</span>
<span class="fc" id="L76">            ctx.status(200).json(user)</span>
        } else {
<span class="fc" id="L78">            ctx.status(404).json(&quot;No user found with email: $foundEmail&quot;)</span>
        }
<span class="fc" id="L80">    }</span>

    fun deleteUser(ctx: Context){
<span class="fc" id="L83">        val foundId = ctx.pathParam(&quot;user-id&quot;).toInt()</span>
<span class="fc bfc" id="L84" title="All 2 branches covered.">        if (userDao.findById(foundId) != null) {</span>
<span class="fc" id="L85">            userDao.delete(foundId)</span>
<span class="fc" id="L86">            ctx.status(204).json(&quot;User with id: ${foundId}, deleted successfully&quot;)</span>
        } else {
<span class="fc" id="L88">            ctx.status(404).json(&quot;User with id ${foundId}, does not exist&quot;)</span>
        }
<span class="fc" id="L90">    }</span>

    fun updateUser(ctx: Context){
<span class="fc" id="L93">        val foundId = ctx.pathParam(&quot;user-id&quot;).toInt()</span>
<span class="fc" id="L94">        val user : UserDTO = jsonToObject(ctx.body())</span>
<span class="fc bfc" id="L95" title="All 2 branches covered.">        if ((userDao.update(id = foundId, userDTO=user)) != 0)</span>
<span class="fc" id="L96">            ctx.status(204).json(&quot;User with id: $foundId, updated successfully&quot;)</span>
        else
<span class="fc" id="L98">            ctx.status(404).json(&quot;User with id: $foundId, not found &quot;)</span>
<span class="fc" id="L99">    }</span>

    fun login (ctx: Context) {
<span class="fc" id="L102">        val mapper = jacksonObjectMapper()</span>
<span class="fc" id="L103">        val user = mapper.readValue&lt;UserDTO&gt;(ctx.body())</span>
<span class="fc" id="L104">        val existingUser = userDao.findByEmail(user.email)</span>
<span class="fc" id="L105">        val secret = Base64.getDecoder().decode(Env.get(&quot;JWT_SECRET&quot;))</span>
<span class="fc bfc" id="L106" title="All 2 branches covered.">        if (existingUser != null) {</span>
<span class="fc bfc" id="L107" title="All 2 branches covered.">            if(decryptPassword(user.password, existingUser.password)) {</span>
<span class="fc" id="L108">                val jwt = Jwts.builder()</span>
<span class="fc" id="L109">                    .claim(&quot;User&quot;, existingUser)</span>
<span class="fc" id="L110">                    .signWith(Keys.hmacShaKeyFor(secret))</span>
<span class="fc" id="L111">                    .compact()</span>
<span class="fc" id="L112">                ctx.status(200).json(jwt)</span>
            } else {
<span class="fc" id="L114">                ctx.status(401).json(&quot;Invalid email or password&quot;)</span>
<span class="fc" id="L115">            }</span>
        } else {
<span class="fc" id="L117">            ctx.res.sendError(401, &quot;Invalid email or password&quot;)</span>
            // ctx.json(&quot;Invalid email or password&quot;)
        }
<span class="fc" id="L120">    }</span>

    //--------------------------------------------------------------
    // ExerciseDAO specifics
    //-------------------------------------------------------------

    fun getAllExercises (ctx: Context) {
<span class="fc" id="L127">        val exercises = exerciseDao.getAll()</span>
<span class="pc bpc" id="L128" title="1 of 2 branches missed.">        if (exercises.size != 0) {</span>
<span class="fc" id="L129">            ctx.status(200).json(exercises)</span>
        } else {
<span class="nc" id="L131">            ctx.status(404).json(&quot;Error 404 - No Exercises Found!!&quot;)</span>
        }
<span class="fc" id="L133">    }</span>

    fun countAllExercises (ctx: Context) {
<span class="nc" id="L136">        val exercises = exerciseDao.getAll().size</span>
<span class="nc bnc" id="L137" title="All 2 branches missed.">        if (exercises != 0) {</span>
<span class="nc" id="L138">            ctx.status(200).json(exercises)</span>
        } else {
<span class="nc" id="L140">            ctx.status(404).json(&quot;Error 404 - No Exercises Found!!&quot;)</span>
        }
<span class="nc" id="L142">    }</span>

    fun getExercisesByUserId (ctx: Context) {
<span class="fc bfc" id="L145" title="All 2 branches covered.">        if (userDao.findById(ctx.pathParam(&quot;user-id&quot;).toInt()) != null) {</span>
<span class="fc" id="L146">            val exercises = exerciseDao.findExerciseByUserId(ctx.pathParam(&quot;user-id&quot;).toInt())</span>
<span class="fc bfc" id="L147" title="All 4 branches covered.">            if (exercises.isNotEmpty()) {</span>
<span class="fc" id="L148">                ctx.status(200).json(exercises)</span>
            } else {
<span class="fc" id="L150">                ctx.status(404).json(&quot;No exercises found&quot;)</span>
<span class="fc" id="L151">            }</span>
        } else {
<span class="fc" id="L153">            ctx.status(404).json(&quot;No exercises associated with user&quot;)</span>
        }
<span class="fc" id="L155">    }</span>

    fun getExercisesByExerciseId (ctx: Context) {
<span class="fc" id="L158">        val exercise = exerciseDao.findByExerciseId(ctx.pathParam(&quot;exercise-id&quot;).toInt())</span>
<span class="fc bfc" id="L159" title="All 2 branches covered.">        if (exercise != null) {</span>
<span class="fc" id="L160">            ctx.status(200).json(exercise)</span>
        } else {
<span class="fc" id="L162">            ctx.status(404).json(&quot;No exercises found&quot;)</span>
        }
<span class="fc" id="L164">    }</span>

    fun addExercise (ctx: Context) {
<span class="fc" id="L167">        val exerciseDTO : ExerciseDTO = jsonToObject(ctx.body())</span>
<span class="pc bpc" id="L168" title="1 of 2 branches missed.">        val userId = exerciseDTO.userId?.let { userDao.findById(it) }</span>
<span class="fc bfc" id="L169" title="All 2 branches covered.">        if (userId != null) {</span>
<span class="fc" id="L170">            val exerciseId = exerciseDao.save(exerciseDTO)</span>
<span class="pc bpc" id="L171" title="1 of 2 branches missed.">            if (exerciseId != null) {</span>
<span class="fc" id="L172">                exerciseDTO.id = exerciseId</span>
<span class="fc" id="L173">                ctx.status(201).json(exerciseDTO)</span>
            }
        } else {
<span class="fc" id="L176">            ctx.status(404).json(&quot;Cannot add exercise to userid: $userId&quot;)</span>
        }
<span class="fc" id="L178">    }</span>

    fun updateExercise (ctx: Context) {
<span class="fc" id="L181">        val foundId = ctx.pathParam(&quot;exercise-id&quot;).toInt()</span>
<span class="fc" id="L182">        val exercise : ExerciseDTO = jsonToObject(ctx.body())</span>
<span class="fc bfc" id="L183" title="All 2 branches covered.">        if (exerciseDao.updateByExerciseId(exerciseId = foundId, exerciseDTO = exercise) != 0) {</span>
<span class="fc" id="L184">            ctx.status(204).json(&quot;Exercise with id: $foundId, updated successfully&quot;)</span>
        } else {
<span class="fc" id="L186">            ctx.status(404).json(&quot;Could not find exercise with id: $foundId&quot;)</span>
        }
<span class="fc" id="L188">    }</span>

    fun incrementView (ctx: Context) {
<span class="fc" id="L191">        val foundId = ctx.pathParam(&quot;exercise-id&quot;).toInt()</span>
<span class="fc" id="L192">        val foundExercise = exerciseDao.findByExerciseId(foundId)</span>
<span class="fc bfc" id="L193" title="All 2 branches covered.">        if (foundExercise != null) {</span>
<span class="pc bpc" id="L194" title="1 of 2 branches missed.">            val increment = foundExercise.views?.plus(1)</span>
<span class="fc" id="L195">            val exercise: ExerciseDTO = jsonToObject(&quot;{\&quot;views\&quot;:\&quot;$increment\&quot;}&quot;)</span>
<span class="pc bpc" id="L196" title="1 of 2 branches missed.">            if (exerciseDao.updateByExerciseId(exerciseId = foundId, exerciseDTO = exercise) != 0) {</span>
<span class="fc" id="L197">                ctx.status(201).json(&quot;Successfully incremented view, new value = $increment&quot;)</span>
            }
        } else {
<span class="fc" id="L200">            ctx.status(404).json(&quot;Could not find the exercise with id: $foundId&quot;)</span>
        }
<span class="fc" id="L202">    }</span>

    fun deleteExerciseByExerciseId (ctx: Context) {
<span class="fc" id="L205">        val foundId = ctx.pathParam(&quot;exercise-id&quot;).toInt()</span>
<span class="fc bfc" id="L206" title="All 2 branches covered.">        if (exerciseDao.findByExerciseId(foundId) != null) {</span>
<span class="fc" id="L207">            exerciseDao.deleteByExerciseId(foundId)</span>
<span class="fc" id="L208">            ctx.status(204).json(&quot;Exercise with id: $foundId, deleted successfully&quot;)</span>
        } else {
<span class="fc" id="L210">            ctx.status(404).json(&quot;Exercise with id $foundId, does not exist&quot;)</span>
        }
<span class="fc" id="L212">    }</span>

    fun deleteExerciseByUserId (ctx: Context) {
<span class="fc" id="L215">        val foundId = ctx.pathParam(&quot;user-id&quot;).toInt()</span>
<span class="pc bpc" id="L216" title="1 of 2 branches missed.">        if (exerciseDao.deleteByExerciseId(foundId) != 0) {</span>
<span class="nc" id="L217">            ctx.status(204).json(&quot;Exercises belonging to user with id: $foundId, deleted successfully&quot;)</span>
        } else {
<span class="fc" id="L219">            ctx.status(404).json(&quot;No Exercises found for user with id: $foundId&quot;)</span>
        }
<span class="fc" id="L221">    }</span>

    //--------------------------------------------------------------
    // MealDAO specifics
    //-------------------------------------------------------------

    fun getAllMeals(ctx: Context) {
<span class="fc" id="L228">        val meals = mealDao.getAll()</span>
<span class="pc bpc" id="L229" title="1 of 2 branches missed.">        if (meals.size != 0) {</span>
<span class="fc" id="L230">            ctx.status(200).json(meals)</span>
        } else {
<span class="nc" id="L232">            ctx.status(404)</span>
<span class="nc" id="L233">            ctx.html(&quot;Error 404 - No Meals Found!!&quot;)</span>
        }
<span class="fc" id="L235">    }</span>

    fun countAllMeals (ctx: Context) {
<span class="nc" id="L238">        val mealsCount = mealDao.getAll().size</span>
<span class="nc bnc" id="L239" title="All 2 branches missed.">        if (mealsCount != 0) {</span>
<span class="nc" id="L240">            ctx.status(200).json(mealsCount)</span>
        } else {
<span class="nc" id="L242">            ctx.status(404).json(&quot;Error 404 - No Meals Found!!&quot;)</span>
        }
<span class="nc" id="L244">    }</span>

    fun getMealsByMealId (ctx: Context) {
<span class="fc" id="L247">        val meal = mealDao.findByMealId(ctx.pathParam(&quot;meal-id&quot;).toInt())</span>
<span class="fc bfc" id="L248" title="All 2 branches covered.">        if (meal != null) {</span>
<span class="fc" id="L249">            ctx.status(200).json(meal)</span>
        } else {
<span class="fc" id="L251">            ctx.status(404).html(&quot;No meals found&quot;)</span>
        }
<span class="fc" id="L253">    }</span>
    fun getMealsByUserId (ctx: Context) {
<span class="fc" id="L255">        val meal = mealDao.findMealByUserId(ctx.pathParam(&quot;user-id&quot;).toInt())</span>
<span class="fc bfc" id="L256" title="All 4 branches covered.">        if (meal.isNotEmpty()) {</span>
<span class="fc" id="L257">            ctx.status(200).json(meal)</span>
        } else {
<span class="fc" id="L259">            ctx.status(404).html(&quot;No meals found&quot;)</span>
        }
<span class="fc" id="L261">    }</span>


    fun getMealIngredients (ctx: Context) {
<span class="nc" id="L265">        val meal = mealDao.findByMealId(ctx.pathParam(&quot;meal-id&quot;).toInt())</span>
<span class="nc bnc" id="L266" title="All 2 branches missed.">        if (meal != null) {</span>
<span class="nc" id="L267">            val ingredients = ingredientDao.findIngredientsForMeal(meal.id)</span>
<span class="nc bnc" id="L268" title="All 2 branches missed.">            if (ingredients.size != 0) {</span>
<span class="nc" id="L269">                ctx.status(200).json(ingredients)</span>
            } else {
<span class="nc" id="L271">                ctx.status(404).json(&quot;No ingredients found&quot;)</span>
<span class="nc" id="L272">            }</span>
        } else {
<span class="nc" id="L274">            ctx.status(404).html(&quot;No Meal found&quot;)</span>
        }
<span class="nc" id="L276">    }</span>

    fun addMeal (ctx: Context) {
<span class="fc" id="L279">        val mealDTO : MealDTO = jsonToObject(ctx.body())</span>
<span class="pc bpc" id="L280" title="1 of 2 branches missed.">        val userId = mealDTO.userId?.let { userDao.findById(it) }</span>
<span class="fc bfc" id="L281" title="All 2 branches covered.">        if (userId != null) {</span>
<span class="fc" id="L282">            val mealId = mealDao.save(mealDTO)</span>
<span class="pc bpc" id="L283" title="1 of 2 branches missed.">            if (mealId != null) {</span>
<span class="fc" id="L284">                mealDTO.id = mealId</span>
<span class="fc" id="L285">                ctx.status(201).json(mealDTO)</span>
            }
        } else {
<span class="fc" id="L288">            ctx.status(409).json(&quot;Could not add meal&quot;)</span>
        }
<span class="fc" id="L290">    }</span>

    fun updateMeal (ctx: Context) {
<span class="nc" id="L293">        val meal : MealDTO = jsonToObject(ctx.body())</span>
<span class="nc bnc" id="L294" title="All 2 branches missed.">        if (mealDao.updateByMealId(mealId = ctx.pathParam(&quot;meal-id&quot;).toInt(), mealDTO = meal) != 0) {</span>
<span class="nc" id="L295">            ctx.status(204)</span>
        } else {
<span class="nc" id="L297">            ctx.status(404)</span>
        }
<span class="nc" id="L299">    }</span>

    fun deleteMealByMealId (ctx: Context) {
<span class="nc" id="L302">        val foundId = ctx.pathParam(&quot;meal-id&quot;).toInt()</span>
<span class="nc bnc" id="L303" title="All 2 branches missed.">        if (mealDao.findByMealId(foundId) != null) {</span>
<span class="nc" id="L304">            mealDao.deleteByMealId(foundId)</span>
<span class="nc" id="L305">            ctx.status(204).html(&quot;Meal with id: $foundId, deleted successfully&quot;)</span>
        } else {
<span class="nc" id="L307">            ctx.status(404).json(&quot;Meal with id $foundId, does not exist&quot;)</span>
        }
<span class="nc" id="L309">    }</span>

    fun assignIngredientIdToMealId (ctx: Context) {
<span class="nc" id="L312">        val foundMealId = ctx.pathParam(&quot;meal-id&quot;).toInt()</span>
<span class="nc" id="L313">        val foundIngredientId = ctx.pathParam(&quot;ingredient-id&quot;).toInt()</span>
<span class="nc" id="L314">        print(&quot;meal: $foundMealId, ingredient: $foundIngredientId&quot;)</span>
<span class="nc bnc" id="L315" title="All 2 branches missed.">        if (mealDao.findByMealId(foundMealId) != null) {</span>
<span class="nc bnc" id="L316" title="All 2 branches missed.">            if (ingredientDao.findByIngredientId(foundIngredientId) != null) {</span>
<span class="nc" id="L317">                val mealIngredient: MealIngredientDTO = jsonToObject(&quot;{\&quot;mealId\&quot;:\&quot;$foundMealId\&quot;, \&quot;ingredientId\&quot;:\&quot;$foundIngredientId\&quot;}&quot;)</span>
<span class="nc" id="L318">                mealDao.saveMealAndIngredientId(mealIngredient)</span>
<span class="nc" id="L319">                saveNutrientsForMeals(foundMealId)</span>
<span class="nc" id="L320">                ctx.status(200)</span>
            } else {
<span class="nc" id="L322">                ctx.status(404).json(&quot;Ingredient with id $foundIngredientId, does not exist&quot;)</span>
<span class="nc" id="L323">            }</span>
        } else {
<span class="nc" id="L325">            ctx.status(404).json(&quot;Meal with id $foundMealId, does not exist&quot;)</span>
        }
<span class="nc" id="L327">    }</span>

    fun incrementMealLoves (ctx: Context) {
<span class="nc" id="L330">        val foundId = ctx.pathParam(&quot;meal-id&quot;).toInt()</span>
<span class="nc" id="L331">        val foundMeal = mealDao.findByMealId(foundId)</span>
<span class="nc bnc" id="L332" title="All 2 branches missed.">        if (foundMeal != null) {</span>
<span class="nc bnc" id="L333" title="All 2 branches missed.">            val increment = foundMeal.loves?.plus(1)</span>
<span class="nc" id="L334">            val meal: MealDTO = jsonToObject(&quot;{\&quot;loves\&quot;:\&quot;$increment\&quot;}&quot;)</span>
<span class="nc bnc" id="L335" title="All 2 branches missed.">            if (mealDao.updateByMealId(mealId = foundId, mealDTO = meal) != 0) {</span>
<span class="nc" id="L336">                ctx.status(201).json(&quot;Successfully incremented love, new value = $increment&quot;)</span>
            }
        } else {
<span class="nc" id="L339">            ctx.status(404).json(&quot;Could not find the meal with id: $foundId&quot;)</span>
        }
<span class="nc" id="L341">    }</span>


    //--------------------------------------------------------------
    // IngredientDAO specifics
    //-------------------------------------------------------------

    fun getAllIngredients(ctx: Context) {
<span class="nc" id="L349">        val ingredients = ingredientDao.getAll()</span>
<span class="nc bnc" id="L350" title="All 2 branches missed.">        if (ingredients.size != 0) {</span>
<span class="nc" id="L351">            ctx.status(200).json(ingredients)</span>
        } else {
<span class="nc" id="L353">            ctx.status(404)</span>
<span class="nc" id="L354">            ctx.html(&quot;Error 404 - No Ingredients Found!!&quot;)</span>
        }
<span class="nc" id="L356">    }</span>

    fun getIngredientsByIngredientId (ctx: Context) {
<span class="nc" id="L359">        val ingredient = ingredientDao.findByIngredientId(ctx.pathParam(&quot;ingredient-id&quot;).toInt())</span>
<span class="nc bnc" id="L360" title="All 2 branches missed.">        if (ingredient != null) {</span>
<span class="nc" id="L361">            ctx.status(200).json(ingredient)</span>
        } else {
<span class="nc" id="L363">            ctx.status(404).html(&quot;No ingredients found&quot;)</span>
        }
<span class="nc" id="L365">    }</span>

    fun addIngredient (ctx: Context) {
<span class="nc" id="L368">        val ingredient : IngredientDTO = jsonToObject(ctx.body())</span>
<span class="nc" id="L369">        val ingredientId = ingredientDao.save(ingredient)</span>
<span class="nc bnc" id="L370" title="All 2 branches missed.">        if (ingredientId != null) {</span>
<span class="nc" id="L371">            ctx.json(ingredient)</span>
<span class="nc" id="L372">            ctx.status(201)</span>
        } else {
<span class="nc" id="L374">            ctx.status(409).json(&quot;Could not add ingredient&quot;)</span>
        }
<span class="nc" id="L376">    }</span>

    fun updateIngredient (ctx: Context) {
<span class="nc" id="L379">        val ingredient : IngredientDTO = jsonToObject(ctx.body())</span>
<span class="nc bnc" id="L380" title="All 2 branches missed.">        if (ingredientDao.updateByIngredientId(ingredientId = ctx.pathParam(&quot;ingredient-id&quot;).toInt(), ingredientDTO = ingredient) != 0) {</span>
<span class="nc" id="L381">            ctx.status(204)</span>
        } else {
<span class="nc" id="L383">            ctx.status(404)</span>
        }
<span class="nc" id="L385">    }</span>

    fun deleteIngredientByIngredientId (ctx: Context) {
<span class="nc" id="L388">        val foundId = ctx.pathParam(&quot;ingredient-id&quot;).toInt()</span>
<span class="nc bnc" id="L389" title="All 2 branches missed.">        if (ingredientDao.findByIngredientId(foundId) != null) {</span>
<span class="nc" id="L390">            ingredientDao.deleteByIngredientId(foundId)</span>
<span class="nc" id="L391">            ctx.status(204).html(&quot;Ingredient with id: $foundId, deleted successfully&quot;)</span>
        } else {
<span class="nc" id="L393">            ctx.status(404).json(&quot;Ingredient with id $foundId, does not exist&quot;)</span>
        }
<span class="nc" id="L395">    }</span>

    fun countAllMealIngredients (ctx: Context) {
<span class="nc" id="L398">        val foundId = ctx.pathParam(&quot;meal-id&quot;).toInt()</span>
<span class="nc bnc" id="L399" title="All 2 branches missed.">        if (mealDao.findByMealId(foundId) != null) {</span>
<span class="nc" id="L400">            val count = ingredientDao.countAmountOfIngredientsInMeal(foundId)</span>
<span class="nc" id="L401">            ctx.status(200).json(count)</span>
        } else {
<span class="nc" id="L403">            ctx.status(404).json(&quot;Meal with id $foundId, does not exist&quot;)</span>
        }
<span class="nc" id="L405">    }</span>

    private fun saveNutrientsForMeals (mealId: Int) {
<span class="nc" id="L408">        val sumEnergy = ingredientDao.countEnergyForMeal(mealId)</span>
<span class="nc" id="L409">        val sumCalories = ingredientDao.countCaloriesForMeal(mealId)</span>
<span class="nc" id="L410">        val sumProtein = ingredientDao.countProteinForMeal(mealId)</span>
<span class="nc" id="L411">        val sumFat = ingredientDao.countFatForMeal(mealId)</span>
<span class="nc" id="L412">        val sumCarbs = ingredientDao.countCarbsForMeal(mealId)</span>
<span class="nc" id="L413">        val sumSodium = ingredientDao.countSodiumForMeal(mealId)</span>
<span class="nc" id="L414">        val meal: MealDTO = jsonToObject(&quot;{\&quot;energy\&quot;:\&quot;$sumEnergy\&quot;, \&quot;calories\&quot;:\&quot;$sumCalories\&quot;, \&quot;protein\&quot;:\&quot;$sumProtein\&quot;,&quot; +</span>
<span class="nc" id="L415">                &quot; \&quot;fat\&quot;:\&quot;$sumFat\&quot;, \&quot;carbs\&quot;:\&quot;$sumCarbs\&quot;, \&quot;sodium\&quot;:\&quot;$sumSodium\&quot;}&quot;)</span>
<span class="nc" id="L416">        mealDao.updateByMealId(mealId, meal)</span>
<span class="nc" id="L417">    }</span>

    /**
     *
     * New feature
     * Make a route and method to save the bmi score to database which can be used to graph
     *
     */

    fun getBmiScoresByUserId (ctx: Context) {
<span class="nc" id="L427">        val foundId = ctx.pathParam(&quot;user-id&quot;).toInt()</span>
<span class="nc" id="L428">        val bmiScores = userBmiDAO.findBmiScoresByUserId(foundId)</span>
<span class="nc bnc" id="L429" title="All 2 branches missed.">        if (bmiScores.size != 0) {</span>
<span class="nc" id="L430">            ctx.status(200).json(bmiScores)</span>
        } else {
<span class="nc" id="L432">            ctx.status(404).json(&quot;Bmi score with id $foundId, does not exist&quot;)</span>
        }
<span class="nc" id="L434">    }</span>

    fun addBmiScore (ctx: Context) {
<span class="nc" id="L437">        val bmi : UserBmiDTO = jsonToObject(ctx.body())</span>
<span class="nc" id="L438">        val bmiId = userBmiDAO.save(bmi)</span>
<span class="nc bnc" id="L439" title="All 2 branches missed.">        if (bmiId != null) {</span>
<span class="nc" id="L440">            ctx.json(bmi)</span>
<span class="nc" id="L441">            ctx.status(201)</span>
        } else {
<span class="nc" id="L443">            ctx.status(409).json(&quot;Could not add bmi score&quot;)</span>
        }
<span class="nc" id="L445">    }</span>

}
</pre><div class="footer"><span class="right">Created with <a href="http://www.jacoco.org/jacoco">JaCoCo</a> 0.8.7.202105040129</span></div></body></html>